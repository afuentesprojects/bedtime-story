<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedtime Story Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸŒ™ Bedtime Story Generator</h1>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <div id="loggedOut">
                <div id="loginForm">
                    <h3>Login</h3>
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <div class="auth-buttons">
                        <button type="button" id="loginBtn">Login</button>
                        <button type="button" id="showRegisterBtn" class="secondary-btn">Create Account</button>
                    </div>
                    <p id="loginError" class="auth-error" style="display: none;"></p>
                </div>
                <div id="registerForm" style="display: none;">
                    <h3>Create Account</h3>
                    <input type="text" id="registerName" placeholder="Display Name">
                    <input type="email" id="registerEmail" placeholder="Email" required>
                    <input type="password" id="registerPassword" placeholder="Password (min 6 chars)" required>
                    <div class="auth-buttons">
                        <button type="button" id="registerBtn">Register</button>
                        <button type="button" id="showLoginBtn" class="secondary-btn">Back to Login</button>
                    </div>
                    <p id="registerError" class="auth-error" style="display: none;"></p>
                </div>
            </div>
            <div id="loggedIn" style="display: none;">
                <span>Welcome, <strong id="displayUsername"></strong>!</span>
                <button type="button" id="logoutBtn">Logout</button>
                <button type="button" id="myStoriesBtn">My Stories</button>
                <button type="button" id="settingsBtn">Settings</button>
            </div>
        </div>

        <!-- Story Creation Interface -->
        <div class="story-creator">
            <h2 id="mainHeader">What kind of story tonight?</h2>
            
            <!-- Step 1: Story Type Selection -->
            <div class="story-type-selection">
                <div class="story-type-card" data-type="original" style="background-image: url('{{ url_for('static', filename='images/icons/original-story.webp') }}')">
                    <div class="card-overlay">
                        <h3>Original Story</h3>
                        <p>Create something completely new</p>
                        <small>âœ¨ Surprise me or tell me what you want</small>
                    </div>
                </div>

                <div class="story-type-card" data-type="classic" style="background-image: url('{{ url_for('static', filename='images/icons/classic-story.webp') }}')">
                    <div class="card-overlay">
                        <h3>Classic Tale</h3>
                        <p>Tell a timeless favorite</p>
                        <small>ğŸ² Choose or get a surprise</small>
                    </div>
                </div>

                <div class="story-type-card" data-type="classic_mixed" style="background-image: url('{{ url_for('static', filename='images/icons/classic-with-my-own-touch.webp') }}')">
                    <div class="card-overlay">
                        <h3>Classic + My Ideas</h3>
                        <p>Remix a classic with your twist</p>
                        <small>ğŸŒŸ Make classics your own</small>
                    </div>
                </div>
            </div>

            <!-- Step 2: Customization (appears based on selection) -->
            <div class="story-customization">
                <!-- Original Story Options -->
                <div class="customization-section" id="originalCustomization" style="display: none;">
                    <button type="button" class="back-btn" id="backFromOriginal">â† Back to Story Types</button>
                    <h2 class="step-header">âœ¨ Create Your Original Story</h2>
                    
                    <!-- Story Length Selector -->
                    <div class="length-section">
                        <label for="length">Story Length:</label>
                        <div class="length-input-wrapper">
                            <button type="button" class="length-btn" id="lengthDown">âˆ’</button>
                            <input type="number" id="length" name="length" min="1" max="30" value="5" required readonly>
                            <button type="button" class="length-btn" id="lengthUp">+</button>
                            <span class="length-label">minutes</span>
                        </div>
                    </div>
                    
                    <h3>What should the story be about?</h3>
                    <p class="section-description">Leave empty for a surprise, or describe your idea...</p>
                    <textarea id="originalTopic" placeholder="e.g., 'A brave mouse knight' or 'Dragons in space'" rows="3"></textarea>
                    <button type="button" class="generate-btn" id="generateOriginal">Generate Story</button>
                    <div class="auto-generate-hint">Or wait 3 seconds for automatic generation...</div>
                </div>

                <!-- Classic Tale Selection -->
                <div class="customization-section" id="classicCustomization" style="display: none;">
                    <button type="button" class="back-btn" id="backFromClassic">â† Back to Story Types</button>
                    <h2 class="step-header">ğŸ“š Choose Your Classic Tale</h2>
                    
                    <!-- Story Length Selector -->
                    <div class="length-section">
                        <label for="lengthClassic">Story Length:</label>
                        <div class="length-input-wrapper">
                            <button type="button" class="length-btn" id="lengthDownClassic">âˆ’</button>
                            <input type="number" id="lengthClassic" name="lengthClassic" min="1" max="30" value="5" required readonly>
                            <button type="button" class="length-btn" id="lengthUpClassic">+</button>
                            <span class="length-label">minutes</span>
                        </div>
                    </div>
                    
                    <h3>Choose your classic tale</h3>
                    <div class="classic-search">
                        <input type="search" id="taleSearch" placeholder="Search tales..." />
                        <button type="button" class="surprise-btn" id="surpriseMe">ğŸ² Surprise me!</button>
                    </div>
                    <div class="tales-browser" id="talesBrowser">
                        <!-- Classic tales will be loaded here -->
                    </div>
                    <button type="button" class="generate-btn" id="generateClassic" style="display: none;">Generate Story</button>
                </div>

                <!-- Classic + Ideas Options -->
                <div class="customization-section" id="classicMixedCustomization" style="display: none;">
                    <button type="button" class="back-btn" id="backFromClassicMixed">â† Back to Story Types</button>
                    <h2 class="step-header">ğŸ­ Remix a Classic Story</h2>
                    
                    <!-- Story Length Selector -->
                    <div class="length-section">
                        <label for="lengthClassicMixed">Story Length:</label>
                        <div class="length-input-wrapper">
                            <button type="button" class="length-btn" id="lengthDownClassicMixed">âˆ’</button>
                            <input type="number" id="lengthClassicMixed" name="lengthClassicMixed" min="1" max="30" value="5" required readonly>
                            <button type="button" class="length-btn" id="lengthUpClassicMixed">+</button>
                            <span class="length-label">minutes</span>
                        </div>
                    </div>
                    
                    <h3>Pick your classic tale</h3>
                    <div class="classic-search">
                        <input type="search" id="taleSearchMixed" placeholder="Search tales..." />
                    </div>
                    <div class="tales-browser" id="talesBrowserMixed">
                        <!-- Classic tales will be loaded here -->
                    </div>
                    
                    <div class="modification-section" id="modificationSection" style="display: none;">
                        <h3>What's your awesome twist?</h3>
                        <textarea id="classicModifications" placeholder="e.g., 'Make Little Red Riding Hood a space explorer'" rows="3"></textarea>
                        <button type="button" class="generate-btn" id="generateClassicMixed">Generate Story</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" style="display: none;">
            <p>âœ¨ Generating your bedtime story...</p>
        </div>

        <!-- Story Output -->
        <div id="storyOutput" style="display: none;">
            <h2 id="storyTitle"></h2>
            <div id="storyText"></div>

            <!-- Save Story Section (only visible when logged in) -->
            <div id="saveSection" style="display: none;">
                <div class="rating-section">
                    <label>Rate this story:</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">&#9733;</span>
                        <span class="star" data-rating="2">&#9733;</span>
                        <span class="star" data-rating="3">&#9733;</span>
                        <span class="star" data-rating="4">&#9733;</span>
                        <span class="star" data-rating="5">&#9733;</span>
                    </div>
                </div>
                <button type="button" id="saveStoryBtn">Save Story</button>
                <p id="saveMessage" style="display: none;"></p>
            </div>

            <button id="newStoryBtn">Generate Another Story</button>
        </div>

        <!-- My Stories Section -->
        <div id="myStoriesSection" style="display: none;">
            <h2>My Saved Stories</h2>
            <div id="storiesList"></div>
            <button type="button" id="backToGeneratorBtn">Back to Generator</button>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" style="display: none;">
            <h2>âš™ï¸ Story Settings</h2>
            <p class="settings-description">Customize how your stories are generated. These preferences will be used every time you create a new story.</p>

            <!-- Child's Age Card -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <span class="settings-icon">ğŸ‘¶</span>
                    <h3>Child's Age</h3>
                </div>
                <p class="settings-card-description">Stories will be tailored to this age level (vocabulary, themes, length).</p>
                <div class="age-input-wrapper">
                    <button type="button" class="age-btn" id="ageDown">âˆ’</button>
                    <input type="number" id="childAge" min="2" max="10" value="6" readonly>
                    <button type="button" class="age-btn" id="ageUp">+</button>
                    <span class="age-label">years old</span>
                </div>
            </div>

            <!-- Story Tone Card -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <span class="settings-icon">ğŸ­</span>
                    <h3>Story Tone</h3>
                </div>
                <p class="settings-card-description">Select the mood and style for your stories (pick as many as you like).</p>
                <div class="checkbox-grid" id="tonesGroup">
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Funny"> ğŸ˜„ Funny</label>
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Soothing"> ğŸ˜Œ Soothing</label>
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Educational"> ğŸ“š Educational</label>
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Fable"> ğŸ¦Š Fable</label>
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Adventure"> âš”ï¸ Adventure</label>
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Magical"> âœ¨ Magical</label>
                </div>
                <div class="custom-tone-wrapper">
                    <label class="checkbox-label"><input type="checkbox" name="tone" value="Other"> Other:</label>
                    <input type="text" id="toneCustom" placeholder="e.g., Silly, Inspirational...">
                </div>
            </div>

            <!-- Favorite Topics Card -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <span class="settings-icon">ğŸ’­</span>
                    <h3>Favorite Topics</h3>
                </div>
                <p class="settings-card-description">What does your child love? Stories will feature these themes.</p>
                <div class="checkbox-grid topics-grid" id="topicsGroup">
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Animals"> ğŸ¾ Animals</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Dinosaurs"> ğŸ¦• Dinosaurs</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Space"> ğŸš€ Space</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Princess"> ğŸ‘‘ Princess</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Pirates"> ğŸ´â€â˜ ï¸ Pirates</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Superheroes"> ğŸ¦¸ Superheroes</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Fantasy"> ğŸ§™ Fantasy</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Nature"> ğŸŒ³ Nature</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Cars"> ğŸš— Cars</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Sports"> âš½ Sports</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Family"> ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Friendship"> ğŸ¤ Friendship</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="School"> ğŸ« School</label>
                    <label class="checkbox-label"><input type="checkbox" name="topic" value="Siblings"> ğŸ‘« Siblings</label>
                </div>
            </div>

            <!-- Language Card -->
            <div class="settings-card">
                <div class="settings-card-header">
                    <span class="settings-icon">ğŸŒ</span>
                    <h3>Story Language</h3>
                </div>
                <p class="settings-card-description">Stories will be translated to your preferred language.</p>
                <select id="preferredLanguage" class="language-select">
                    <option value="English">English</option>
                    <option value="Spanish">Spanish</option>
                    <option value="French">French</option>
                    <option value="Portuguese">Portuguese</option>
                    <option value="German">German</option>
                    <option value="Italian">Italian</option>
                </select>
            </div>

            <button type="button" id="saveSettingsBtn">ğŸ’¾ Save Settings</button>
            <p id="settingsMessage" style="display: none;"></p>
            <button type="button" id="backFromSettingsBtn" class="secondary-btn">â† Back to Generator</button>
        </div>

        <!-- Error Message -->
        <div id="error" style="display: none;">
            <p class="error-message"></p>
        </div>
    </div>

    <script>
        // =============================================================================
        // DOM ELEMENTS - ALL DECLARED AT TOP TO ENSURE AVAILABILITY
        // =============================================================================
        
        // Story creation elements
        const storyTypeCards = document.querySelectorAll('.story-type-card');
        const loading = document.getElementById('loading');
        const storyOutput = document.getElementById('storyOutput');
        const storyTitle = document.getElementById('storyTitle');
        const storyText = document.getElementById('storyText');
        const error = document.getElementById('error');
        const newStoryBtn = document.getElementById('newStoryBtn');

        // Customization sections
        const originalCustomization = document.getElementById('originalCustomization');
        const classicCustomization = document.getElementById('classicCustomization');
        const classicMixedCustomization = document.getElementById('classicMixedCustomization');
        
        // Input elements
        const originalTopic = document.getElementById('originalTopic');
        const taleSearch = document.getElementById('taleSearch');
        const taleSearchMixed = document.getElementById('taleSearchMixed');
        const talesBrowser = document.getElementById('talesBrowser');
        const talesBrowserMixed = document.getElementById('talesBrowserMixed');
        const classicModifications = document.getElementById('classicModifications');
        const modificationSection = document.getElementById('modificationSection');
        
        // Generate buttons
        const generateOriginal = document.getElementById('generateOriginal');
        const generateClassic = document.getElementById('generateClassic');
        const generateClassicMixed = document.getElementById('generateClassicMixed');
        const surpriseMe = document.getElementById('surpriseMe');

        // Login elements
        const loggedOut = document.getElementById('loggedOut');
        const loggedIn = document.getElementById('loggedIn');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const registerBtn = document.getElementById('registerBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const displayUsername = document.getElementById('displayUsername');
        const myStoriesBtn = document.getElementById('myStoriesBtn');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        
        // Save story elements
        const saveSection = document.getElementById('saveSection');
        const starRating = document.getElementById('starRating');
        const stars = document.querySelectorAll('.star');
        const saveStoryBtn = document.getElementById('saveStoryBtn');
        const saveMessage = document.getElementById('saveMessage');
        
        // My stories elements
        const myStoriesSection = document.getElementById('myStoriesSection');
        const storiesList = document.getElementById('storiesList');
        const backToGeneratorBtn = document.getElementById('backToGeneratorBtn');
        
        // Settings elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsSection = document.getElementById('settingsSection');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsMessage = document.getElementById('settingsMessage');
        const backFromSettingsBtn = document.getElementById('backFromSettingsBtn');
        const toneCustomInput = document.getElementById('toneCustom');
        const childAgeInput = document.getElementById('childAge');

        // =============================================================================
        // STATE VARIABLES
        // =============================================================================
        
        let currentStoryType = null;
        let selectedClassicTale = null;
        let selectedClassicTaleMixed = null;
        let autoGenerateTimer = null;
        let allTales = [];
        let currentStoryData = {};
        let selectedRating = 0;

        // =============================================================================
        // STORY TYPE SELECTION LOGIC
        // =============================================================================
        
        // Handle story type card clicks
        storyTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                const storyType = this.getAttribute('data-type');
                selectStoryType(storyType);
            });
        });

        function selectStoryType(storyType) {
            // Clear previous selections
            storyTypeCards.forEach(card => card.classList.remove('selected'));
            hideAllCustomizations();
            clearAutoGenerateTimer();

            // Set current selection
            currentStoryType = storyType;
            
            // Hide Step 1 (story type selection) and main header
            document.querySelector('.story-type-selection').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'none';
            
            // Show Step 2 (customization) after a brief transition
            setTimeout(() => {
                switch(storyType) {
                    case 'original':
                        showOriginalCustomization();
                        break;
                    case 'classic':
                        showClassicCustomization();
                        break;
                    case 'classic_mixed':
                        showClassicMixedCustomization();
                        break;
                }
            }, 100); // Small delay for smooth transition
        }

        function hideAllCustomizations() {
            originalCustomization.style.display = 'none';
            classicCustomization.style.display = 'none';
            classicMixedCustomization.style.display = 'none';
            originalCustomization.classList.remove('show');
            classicCustomization.classList.remove('show');
            classicMixedCustomization.classList.remove('show');
        }

        function showOriginalCustomization() {
            originalCustomization.style.display = 'block';
            setTimeout(() => originalCustomization.classList.add('show'), 10);
            startAutoGenerateTimer();
        }

        function showClassicCustomization() {
            classicCustomization.style.display = 'block';
            setTimeout(() => classicCustomization.classList.add('show'), 10);
        }

        function showClassicMixedCustomization() {
            classicMixedCustomization.style.display = 'block';
            setTimeout(() => classicMixedCustomization.classList.add('show'), 10);
        }

        function backToStorySelection() {
            try {
                // Hide all Step 2 sections
                hideAllCustomizations();
                
                // Show Step 1 again
                const storySelection = document.querySelector('.story-type-selection');
                if (storySelection) {
                    storySelection.style.display = 'grid'; // Use grid instead of block
                }
                
                const mainHeader = document.getElementById('mainHeader');
                if (mainHeader) {
                    mainHeader.style.display = 'block'; // Show main header again
                }
                
                // Clear current selection
                currentStoryType = null;
                if (storyTypeCards) {
                    storyTypeCards.forEach(card => card.classList.remove('selected'));
                }
                
                // Clear any timer
                clearAutoGenerateTimer();
            } catch (error) {
                console.error('Error in backToStorySelection:', error);
            }
        }

        // =============================================================================
        // AUTO-GENERATION TIMER FOR ORIGINAL STORIES
        // =============================================================================
        
        function startAutoGenerateTimer() {
            clearAutoGenerateTimer();
            autoGenerateTimer = setTimeout(() => {
                if (currentStoryType === 'original') {
                    generateStory('original', originalTopic.value || '');
                }
            }, 3000); // 3 second delay
        }

        function clearAutoGenerateTimer() {
            if (autoGenerateTimer) {
                clearTimeout(autoGenerateTimer);
                autoGenerateTimer = null;
            }
        }

        // Reset timer when user types in original topic
        originalTopic.addEventListener('input', () => {
            if (currentStoryType === 'original') {
                startAutoGenerateTimer();
            }
        });

        // =============================================================================
        // CLASSIC TALES BROWSER AND SEARCH
        // =============================================================================
        
        async function loadClassicTales() {
            try {
                const response = await fetch('/classic-tales');
                const result = await response.json();
                
                if (result.success) {
                    allTales = result.tales.filter(tale => tale.id !== 'surprise'); // Remove "Surprise me" for browsing
                    allTales.sort((a, b) => a.title.localeCompare(b.title)); // Sort alphabetically
                    renderTalesBrowser(allTales, talesBrowser, 'classic');
                    renderTalesBrowser(allTales, talesBrowserMixed, 'classic_mixed');
                }
            } catch (err) {
                console.error('Error loading classic tales:', err);
            }
        }

        function renderTalesBrowser(tales, container, type) {
            const getEmojiForCategory = (category) => {
                const emojiMap = {
                    'fairy_tale': 'ğŸ§š',
                    'fable': 'ğŸ¦Š', 
                    'myth': 'âš¡',
                    'legend': 'âš”ï¸',
                    'religious': 'ğŸ•Šï¸',
                    'tall_tale': 'ğŸª',
                    'folktale': 'ğŸ¡',
                    'modern_classic': 'ğŸ“–',
                    'classic_chapter': 'ğŸ“š',
                    'classic_short': 'ğŸ“'
                };
                return emojiMap[category] || 'ğŸ“–';
            };

            container.innerHTML = tales.map(tale => `
                <div class="tale-item" data-tale-id="${tale.id}" data-type="${type}">
                    <div class="tale-emoji">${getEmojiForCategory(tale.category)}</div>
                    <div class="tale-info">
                        <h4>${tale.title}</h4>
                        <p>${tale.description}</p>
                    </div>
                </div>
            `).join('');

            // Add click handlers for tale selection
            container.querySelectorAll('.tale-item').forEach(item => {
                item.addEventListener('click', function() {
                    const taleId = this.dataset.taleId;
                    const taleType = this.dataset.type;
                    selectTale(taleId, taleType, this);
                });
            });
        }

        function selectTale(taleId, type, element) {
            // Remove previous selection in this browser
            const container = element.parentElement;
            container.querySelectorAll('.tale-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Mark this tale as selected
            element.classList.add('selected');
            
            if (type === 'classic') {
                selectedClassicTale = taleId;
                generateClassic.style.display = 'block';
            } else if (type === 'classic_mixed') {
                selectedClassicTaleMixed = taleId;
                modificationSection.style.display = 'block';
                setTimeout(() => modificationSection.classList.add('show'), 10);
            }
        }

        // Search functionality
        function setupTaleSearch(searchInput, browser, type) {
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const filteredTales = allTales.filter(tale => 
                    tale.title.toLowerCase().includes(query) ||
                    tale.description.toLowerCase().includes(query)
                );
                renderTalesBrowser(filteredTales, browser, type);
            });
        }

        // =============================================================================
        // BUTTON HANDLERS AND STORY GENERATION
        // =============================================================================
        
        // Generate Original Story
        generateOriginal.addEventListener('click', () => {
            generateStory('original', originalTopic.value || '');
        });

        // Generate Classic Story
        generateClassic.addEventListener('click', () => {
            if (selectedClassicTale) {
                generateStory('classic', '', selectedClassicTale);
            }
        });

        // Generate Classic Mixed Story
        generateClassicMixed.addEventListener('click', () => {
            if (selectedClassicTaleMixed && classicModifications.value.trim()) {
                generateStory('classic_mixed', classicModifications.value, selectedClassicTaleMixed);
            }
        });

        // Surprise Me button
        surpriseMe.addEventListener('click', () => {
            generateStory('classic', '', 'surprise');
        });

        // Main story generation function
        async function generateStory(storyType, modifications = '', classicTaleId = null) {
            // Clear previous results
            hideAllSections();
            loading.style.display = 'block';
            clearAutoGenerateTimer();

            // Get length from the appropriate input based on story type
            let lengthValue;
            if (storyType === 'original') {
                lengthValue = document.getElementById('length').value;
            } else if (storyType === 'classic') {
                lengthValue = document.getElementById('lengthClassic').value;
            } else if (storyType === 'classic_mixed') {
                lengthValue = document.getElementById('lengthClassicMixed').value;
            }

            // Prepare story data
            const storyData = {
                story_type: storyType,
                length: lengthValue,
                modifications: modifications,
                classic_tale_id: classicTaleId,
                user_id: localStorage.getItem('user_id'),
                token: localStorage.getItem('token')
            };

            // Store for saving later
            currentStoryData = storyData;

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(storyData)
                });

                const result = await response.json();
                loading.style.display = 'none';

                if (result.success) {
                    // Extract title and story body
                    const fullStory = result.story;
                    const lines = fullStory.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '').trim();
                    const storyBody = lines.slice(1).join('\n').trim();

                    storyTitle.textContent = title;
                    storyText.textContent = storyBody;
                    currentStoryData.title = title;
                    currentStoryData.story_text = storyBody;
                    currentStoryData.language = result.language || 'English';
                    storyOutput.style.display = 'block';

                    // Show save section if logged in
                    const saveSection = document.getElementById('saveSection');
                    if (isLoggedIn()) {
                        saveSection.style.display = 'block';
                        selectedRating = 0;
                        updateStarDisplay();
                        const saveMessage = document.getElementById('saveMessage');
                        saveMessage.style.display = 'none';
                        document.getElementById('saveStoryBtn').disabled = false;
                    }
                } else {
                    error.querySelector('.error-message').textContent = 'Error generating story: ' + result.error;
                    error.style.display = 'block';
                }
            } catch (err) {
                loading.style.display = 'none';
                error.querySelector('.error-message').textContent = 'Error: Could not connect to the server. ' + err.message;
                error.style.display = 'block';
            }
        }

        function hideAllSections() {
            storyOutput.style.display = 'none';
            error.style.display = 'none';
            document.getElementById('myStoriesSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
        }

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        
        // Initialize the interface
        function initializeInterface() {
            // Load classic tales
            loadClassicTales();
            
            // Setup search functionality
            setupTaleSearch(taleSearch, talesBrowser, 'classic');
            setupTaleSearch(taleSearchMixed, talesBrowserMixed, 'classic_mixed');
            
            // Initialize login state
            checkLogin();
            
            // Hide all customizations initially
            hideAllCustomizations();
        }

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================
        
        // Helper to check if logged in
        function isLoggedIn() {
            return localStorage.getItem('user_id') && localStorage.getItem('token');
        }

        // Update star rating display
        function updateStarDisplay() {
            stars.forEach(star => {
                const rating = parseInt(star.dataset.rating);
                if (rating <= selectedRating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        // Check if user is already logged in
        function checkLogin() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('token');
            const displayName = localStorage.getItem('display_name');

            if (userId && token) {
                loggedOut.style.display = 'none';
                loggedIn.style.display = 'block';
                displayUsername.textContent = displayName || 'User';
            } else {
                loggedOut.style.display = 'block';
                loggedIn.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
        }

        // =============================================================================
        // EVENT HANDLERS - ALL BUTTON CLICKS AND INTERACTIONS  
        // =============================================================================
        
        // Story Type Card Selection
        storyTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                const storyType = this.getAttribute('data-type');
                selectStoryType(storyType);
            });
        });

        // Original Topic Input - Reset Auto-Timer
        originalTopic.addEventListener('input', () => {
            if (currentStoryType === 'original') {
                startAutoGenerateTimer();
            }
        });

        // Generate Buttons
        generateOriginal.addEventListener('click', () => {
            generateStory('original', originalTopic.value || '');
        });

        generateClassic.addEventListener('click', () => {
            if (selectedClassicTale) {
                generateStory('classic', '', selectedClassicTale);
            }
        });

        generateClassicMixed.addEventListener('click', () => {
            if (selectedClassicTaleMixed && classicModifications.value.trim()) {
                generateStory('classic_mixed', classicModifications.value, selectedClassicTaleMixed);
            }
        });

        surpriseMe.addEventListener('click', () => {
            generateStory('classic', '', 'surprise');
        });

        // Length Adjustment Buttons - Original
        document.getElementById('lengthUp').addEventListener('click', function() {
            const lengthInput = document.getElementById('length');
            const current = parseInt(lengthInput.value) || 5;
            if (current < 30) lengthInput.value = current + 1;
        });

        document.getElementById('lengthDown').addEventListener('click', function() {
            const lengthInput = document.getElementById('length');
            const current = parseInt(lengthInput.value) || 5;
            if (current > 1) lengthInput.value = current - 1;
        });

        // Length Adjustment Buttons - Classic
        document.getElementById('lengthUpClassic').addEventListener('click', function() {
            const lengthInput = document.getElementById('lengthClassic');
            const current = parseInt(lengthInput.value) || 5;
            if (current < 30) lengthInput.value = current + 1;
        });

        document.getElementById('lengthDownClassic').addEventListener('click', function() {
            const lengthInput = document.getElementById('lengthClassic');
            const current = parseInt(lengthInput.value) || 5;
            if (current > 1) lengthInput.value = current - 1;
        });

        // Length Adjustment Buttons - Classic Mixed
        document.getElementById('lengthUpClassicMixed').addEventListener('click', function() {
            const lengthInput = document.getElementById('lengthClassicMixed');
            const current = parseInt(lengthInput.value) || 5;
            if (current < 30) lengthInput.value = current + 1;
        });

        document.getElementById('lengthDownClassicMixed').addEventListener('click', function() {
            const lengthInput = document.getElementById('lengthClassicMixed');
            const current = parseInt(lengthInput.value) || 5;
            if (current > 1) lengthInput.value = current - 1;
        });

        // Login/Register Form Toggles
        showRegisterBtn.addEventListener('click', function() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            loginError.style.display = 'none';
        });

        showLoginBtn.addEventListener('click', function() {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            registerError.style.display = 'none';
        });

        // Login Handler
        loginBtn.addEventListener('click', async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                loginError.textContent = 'Please enter email and password';
                loginError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('user_id', result.user_id);
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('display_name', result.display_name);
                    loginError.style.display = 'none';
                    checkLogin();
                } else {
                    loginError.textContent = result.error;
                    loginError.style.display = 'block';
                }
            } catch (err) {
                loginError.textContent = 'Connection error. Please try again.';
                loginError.style.display = 'block';
            }
        });

        // Register Handler
        registerBtn.addEventListener('click', async function() {
            const displayName = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                registerError.textContent = 'Please enter email and password';
                registerError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, display_name: displayName })
                });

                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('user_id', result.user_id);
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('display_name', result.display_name);
                    registerError.style.display = 'none';
                    checkLogin();
                } else {
                    registerError.textContent = result.error;
                    registerError.style.display = 'block';
                }
            } catch (err) {
                registerError.textContent = 'Connection error. Please try again.';
                registerError.style.display = 'block';
            }
        });

        // Logout Handler
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('token');
            localStorage.removeItem('display_name');
            checkLogin();
            saveSection.style.display = 'none';
        });

        // Star Rating Handlers
        stars.forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                updateStarDisplay();
            });

            star.addEventListener('mouseenter', function() {
                const hoverRating = parseInt(this.dataset.rating);
                stars.forEach(s => {
                    if (parseInt(s.dataset.rating) <= hoverRating) {
                        s.classList.add('hovered');
                    } else {
                        s.classList.remove('hovered');
                    }
                });
            });
        });

        starRating.addEventListener('mouseleave', function() {
            stars.forEach(s => s.classList.remove('hovered'));
        });

        // Navigation Handlers
        newStoryBtn.addEventListener('click', function() {
            storyOutput.style.display = 'none';
            document.querySelector('.story-creator').style.display = 'block';
            backToStorySelection(); // Return to Step 1
            window.scrollTo(0, 0);
        });

        // =============================================================================
        // CORE FUNCTIONS
        // =============================================================================

        // Load classic tales
        async function loadClassicTales() {
            try {
                const response = await fetch('/classic-tales');
                const result = await response.json();
                
                if (result.success) {
                    classicTaleSelect.innerHTML = result.tales.map(tale => 
                        `<option value="${tale.id}">${tale.title}</option>`
                    ).join('');
                } else {
                    classicTaleSelect.innerHTML = '<option value="">Error loading tales</option>';
                }
            } catch (err) {
                classicTaleSelect.innerHTML = '<option value="">Error loading tales</option>';
            }
        }

        // Load tales on page load
        loadClassicTales();


        // Star rating click handler
        stars.forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                updateStarDisplay();
            });

            // Hover handlers for preview effect
            star.addEventListener('mouseenter', function() {
                const hoverRating = parseInt(this.dataset.rating);
                stars.forEach(s => {
                    if (parseInt(s.dataset.rating) <= hoverRating) {
                        s.classList.add('hovered');
                    } else {
                        s.classList.remove('hovered');
                    }
                });
            });
        });

        // Remove hover effect when leaving the star rating area
        starRating.addEventListener('mouseleave', function() {
            stars.forEach(s => s.classList.remove('hovered'));
        });

        function updateStarDisplay() {
            stars.forEach(star => {
                const rating = parseInt(star.dataset.rating);
                if (rating <= selectedRating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        // Story saving and rating functionality (keeping existing)

        // Save story handler
        saveStoryBtn.addEventListener('click', async function() {
            if (selectedRating === 0) {
                saveMessage.textContent = 'Please select a rating first!';
                saveMessage.className = 'error-text';
                saveMessage.style.display = 'block';
                return;
            }

            const saveData = {
                user_id: localStorage.getItem('user_id'),
                token: localStorage.getItem('token'),
                title: currentStoryData.title,
                story_text: currentStoryData.story_text,
                story_type: currentStoryData.story_type,
                language: currentStoryData.language,
                length_minutes: currentStoryData.length,
                modifications: currentStoryData.modifications,
                rating: selectedRating
            };

            try {
                const response = await fetch('/save-story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });

                const result = await response.json();

                if (result.success) {
                    saveMessage.textContent = 'Story saved!';
                    saveMessage.className = 'success-text';
                    saveStoryBtn.disabled = true;
                } else {
                    saveMessage.textContent = 'Error saving: ' + result.error;
                    saveMessage.className = 'error-text';
                }
                saveMessage.style.display = 'block';
            } catch (err) {
                saveMessage.textContent = 'Error: Could not save story.';
                saveMessage.className = 'error-text';
                saveMessage.style.display = 'block';
            }
        });

        // My Stories button handler
        myStoriesBtn.addEventListener('click', async function() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('token');
            if (!userId || !token) return;

            try {
                const response = await fetch(`/my-stories?user_id=${userId}&token=${encodeURIComponent(token)}`);
                const result = await response.json();

                if (result.success) {
                    displayStories(result.stories);
                    
                    // Hide all other sections and show my stories
                    hideAllCustomizations();
                    document.querySelector('.story-creator').style.display = 'none';
                    storyOutput.style.display = 'none';
                    settingsSection.style.display = 'none';
                    myStoriesSection.style.display = 'block';
                }
            } catch (err) {
                console.error('Error fetching stories:', err);
            }
        });

        function displayStories(stories) {
            if (stories.length === 0) {
                storiesList.innerHTML = '<p>No saved stories yet.</p>';
                return;
            }

            storiesList.innerHTML = stories.map(story => `
                <div class="saved-story" data-story-id="${story.id}">
                    <h3 class="saved-story-title">${story.title || 'Untitled Story'}</h3>
                    <div class="story-meta">
                        <div class="story-rating-edit star-rating" data-story-id="${story.id}" data-current-rating="${story.rating}">
                            ${[1,2,3,4,5].map(i => `<span class="star ${i <= story.rating ? 'selected' : ''}" data-rating="${i}">&#9733;</span>`).join('')}
                        </div>
                        <span class="story-info">${story.language} | ${story.length_minutes} min | ${story.story_type}</span>
                    </div>
                    <div class="story-preview">${story.story_text.substring(0, 200)}...</div>
                    <details>
                        <summary>Read full story</summary>
                        <div class="story-full">${story.story_text}</div>
                    </details>
                </div>
            `).join('');

            // Add click and hover handlers for editable ratings
            document.querySelectorAll('.story-rating-edit').forEach(ratingDiv => {
                const storyId = ratingDiv.dataset.storyId;
                const starsInDiv = ratingDiv.querySelectorAll('.star');

                starsInDiv.forEach(star => {
                    // Hover effect
                    star.addEventListener('mouseenter', function() {
                        const hoverRating = parseInt(this.dataset.rating);
                        starsInDiv.forEach(s => {
                            if (parseInt(s.dataset.rating) <= hoverRating) {
                                s.classList.add('hovered');
                            } else {
                                s.classList.remove('hovered');
                            }
                        });
                    });

                    // Click to update rating
                    star.addEventListener('click', async function() {
                        const newRating = parseInt(this.dataset.rating);

                        try {
                            const response = await fetch('/update-rating', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    user_id: localStorage.getItem('user_id'),
                                    token: localStorage.getItem('token'),
                                    story_id: storyId,
                                    rating: newRating
                                })
                            });

                            const result = await response.json();
                            if (result.success) {
                                // Update display
                                starsInDiv.forEach(s => {
                                    if (parseInt(s.dataset.rating) <= newRating) {
                                        s.classList.add('selected');
                                    } else {
                                        s.classList.remove('selected');
                                    }
                                });
                                ratingDiv.dataset.currentRating = newRating;
                            }
                        } catch (err) {
                            console.error('Error updating rating:', err);
                        }
                    });
                });

                // Remove hover effect when leaving
                ratingDiv.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(this.dataset.currentRating);
                    starsInDiv.forEach(s => {
                        s.classList.remove('hovered');
                    });
                });
            });
        }

        // Back to generator button
        backToGeneratorBtn.addEventListener('click', function() {
            myStoriesSection.style.display = 'none';
            document.querySelector('.story-creator').style.display = 'block';
            // Ensure we return to Step 1, not Step 2
            backToStorySelection();
        });

        // Settings button handler
        settingsBtn.addEventListener('click', async function() {
            // Hide all other sections and show settings
            hideAllCustomizations();
            document.getElementById('loginSection').style.display = 'none';
            document.querySelector('.story-creator').style.display = 'none';
            storyOutput.style.display = 'none';
            myStoriesSection.style.display = 'none';
            settingsSection.style.display = 'block';
            settingsMessage.style.display = 'none';

            // Load existing settings
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('token');
            if (!userId || !token) return;

            try {
                const response = await fetch(`/settings?user_id=${userId}&token=${encodeURIComponent(token)}`);
                const result = await response.json();

                if (result.success && result.settings) {
                    // Populate tones
                    const tones = result.settings.tones ? JSON.parse(result.settings.tones) : [];
                    document.querySelectorAll('input[name="tone"]').forEach(cb => {
                        cb.checked = tones.includes(cb.value);
                    });
                    toneCustomInput.value = result.settings.tone_custom || '';

                    // Populate topics
                    const topics = result.settings.favorite_topics ? JSON.parse(result.settings.favorite_topics) : [];
                    document.querySelectorAll('input[name="topic"]').forEach(cb => {
                        cb.checked = topics.includes(cb.value);
                    });

                    // Populate age
                    childAgeInput.value = result.settings.child_age || 6;

                    // Populate language
                    document.getElementById('preferredLanguage').value = result.settings.preferred_language || 'English';
                }
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        });

        // Save settings handler
        saveSettingsBtn.addEventListener('click', async function() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('token');
            if (!userId || !token) return;

            // Gather selected tones
            const tones = [];
            document.querySelectorAll('input[name="tone"]:checked').forEach(cb => {
                tones.push(cb.value);
            });

            // Gather selected topics
            const topics = [];
            document.querySelectorAll('input[name="topic"]:checked').forEach(cb => {
                topics.push(cb.value);
            });

            const settingsData = {
                user_id: userId,
                token: token,
                tones: JSON.stringify(tones),
                tone_custom: toneCustomInput.value.trim(),
                favorite_topics: JSON.stringify(topics),
                child_age: parseInt(childAgeInput.value) || 6,
                preferred_language: document.getElementById('preferredLanguage').value
            };

            try {
                const response = await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (result.success) {
                    settingsMessage.textContent = 'Settings saved!';
                    settingsMessage.className = 'success-text';
                } else {
                    settingsMessage.textContent = 'Error: ' + result.error;
                    settingsMessage.className = 'error-text';
                }
                settingsMessage.style.display = 'block';
            } catch (err) {
                settingsMessage.textContent = 'Error saving settings.';
                settingsMessage.className = 'error-text';
                settingsMessage.style.display = 'block';
            }
        });

        // Back from settings button
        backFromSettingsBtn.addEventListener('click', function() {
            settingsSection.style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.querySelector('.story-creator').style.display = 'block';
            // Ensure we return to Step 1, not Step 2
            backToStorySelection();
        });

        // Age +/- buttons for settings
        document.getElementById('ageUp').addEventListener('click', function() {
            const ageInput = document.getElementById('childAge');
            const current = parseInt(ageInput.value) || 6;
            if (current < 10) ageInput.value = current + 1;
        });

        document.getElementById('ageDown').addEventListener('click', function() {
            const ageInput = document.getElementById('childAge');
            const current = parseInt(ageInput.value) || 6;
            if (current > 2) ageInput.value = current - 1;
        });

        // Back button handlers
        const backFromOriginal = document.getElementById('backFromOriginal');
        const backFromClassic = document.getElementById('backFromClassic');
        const backFromClassicMixed = document.getElementById('backFromClassicMixed');
        
        if (backFromOriginal) {
            backFromOriginal.addEventListener('click', backToStorySelection);
        }
        if (backFromClassic) {
            backFromClassic.addEventListener('click', backToStorySelection);
        }
        if (backFromClassicMixed) {
            backFromClassicMixed.addEventListener('click', backToStorySelection);
        }

        // Initialize the interface when page loads
        initializeInterface();
    </script>
</body>
</html>
